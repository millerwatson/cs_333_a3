<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Mercator Map with Tooltip</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://d3js.org/topojson.v3.min.js"></script>
  <style>
    body { margin: 0; }
    svg { width: 100vw; height: 100vh; display: block; }

    /* Simple tooltip styling */
    .tooltip {
      position: absolute;
      background: white;
      padding: 6px 10px;
      border: 1px solid #777;
      border-radius: 4px;
      pointer-events: none;
      font-family: sans-serif;
      font-size: 13px;
      opacity: 0;
      transition: opacity 0.15s;
    }
  </style>
</head>
<body>
  <svg></svg>
  <div class="tooltip"></div>

  <script>
  const width = window.innerWidth;
  const height = window.innerHeight;

  const svg = d3.select("svg");
  const tooltip = d3.select(".tooltip");

  const projection = d3.geoMercator()
    .scale(150)
    .translate([width / 2, height / 2]);

  const path = d3.geoPath().projection(projection);

  const zoom = d3.zoom()
    .scaleExtent([1, 8])
    .on("zoom", (event) => {
      svg.selectAll("g").attr("transform", event.transform);
    });

  svg.call(zoom);

  // Helper: normalize country names for more reliable matching
  function normalize(name) {
    return name
      .toLowerCase()
      .replace(/,/g, "")
      .replace(/\./g, "")
      .replace(/the\s+/g, "")
      .replace(/\s+/g, " ")
      .trim();
  }

  Promise.all([
    d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json"),
    d3.csv("OECD_clean_large.csv")
  ]).then(([worldData, oecd]) => {

    // Filter to Negative Affect for (example) 2024
    const negAffect = oecd.filter(d =>
      normalize(d.measure) === normalize("NEGATIVE AFFECT BALANCE") ||
      d.measure === "NEG_AFFECT" ||   // adjust if your measure code is different
      d.measure === "11_2"            // example
    );

    // Build a map: normalized name â†’ value
    const valueMap = new Map();
    negAffect.forEach(d => {
      const norm = normalize(d.reference_area);
      valueMap.set(norm, +d.value);
    });

    // Compute color domain
    const values = [...valueMap.values()];
    const min = d3.min(values);
    const max = d3.max(values);

    const color = d3.scaleDiverging()
      .domain([min, 0, max])
      .interpolator(d3.interpolateRdBu);

    // Draw map
    const countries = topojson.feature(worldData, worldData.objects.countries);

    svg.append("g")
      .selectAll("path")
      .data(countries.features)
      .enter()
      .append("path")
        .attr("d", path)
        .attr("stroke", "#333")
        .attr("fill", d => {
          const cname = normalize(d.properties.name);
          const val = valueMap.get(cname);
          return val != null ? color(val) : "#dddddd"; // fallback color
        })
        .on("mouseover", function(event, d) {
          const cname = normalize(d.properties.name);
          const val = valueMap.get(cname);

          d3.select(this).attr("opacity", 0.8);

          tooltip
            .style("opacity", 1)
            .html(
              `<strong>${d.properties.name}</strong><br>` +
              (val != null ? `Negative Affect: ${val}` : "No data")
            );
        })
        .on("mousemove", event => {
          tooltip
            .style("left", event.pageX + 10 + "px")
            .style("top", event.pageY + 10 + "px");
        })
        .on("mouseout", function() {
          d3.select(this).attr("opacity", 1);
          tooltip.style("opacity", 0);
        });

  });
</script>

</body>
</html>
