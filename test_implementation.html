<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Mercator Map with Tooltip</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://d3js.org/topojson.v3.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
    }

    /* Layout: map on the left, controls on the right */
    .layout {
      display: flex;
      height: 100vh;
    }

    .legend {
      font-size: 12px;
    }

    /* This is your "box" for the map */
    #map-container {
      flex: 3;
      position: relative;
      border-right: 1px solid #ddd;
    }

    /* SVG fills the map box, not the whole viewport */
    #map-container svg {
      width: 100%;
      height: 100%;
      display: block;
    }

    /* Heatmap main container */
    #heatmap-main-container {
      flex: 3;
      position: relative;
      border-right: 1px solid #ddd;
      padding: 20px;
      overflow: auto;
      display: none;
    }

    /* Right-side control panel */
    #controls {
      flex: 1;             
      padding: 1rem;
      box-sizing: border-box;
      overflow-y: auto;
    }

    /* Simple tooltip styling */
    .tooltip {
      position: absolute;
      background: white;
      padding: 6px 10px;
      border: 1px solid #777;
      border-radius: 4px;
      pointer-events: none;
      font-size: 13px;
      opacity: 0;
      transition: opacity 0.15s;
    }
  </style>
</head>
<body>
  <div id="time-controls" style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
    <button id="play-btn">Play</button>
    <button id="pause-btn">Pause</button>

    <input id="year-slider" type="range" min="2010" max="2024" value="2024" step="1" 
          style="flex-grow:1;">

    <span id="year-label">2024</span>
    
    <button id="toggle-view-btn" style="margin-left:20px; padding:5px 15px;">Show Heatmap</button>
  </div>
  <div class="layout">
    <!-- LEFT: MAP BOX -->
    <div id="map-container">
      <svg></svg>
    </div>

    <!-- LEFT: HEATMAP BOX (initially hidden) -->
    <div id="heatmap-main-container">
      <h2>Correlation Heatmap</h2>
      <svg id="heatmap-main"></svg>
    </div>

    <!-- RIGHT: CHECKBOX MENU -->
    <div id="controls">
      <h3>Factors</h3>
      <label>
        <input type="checkbox" id="show-negative" checked>
        Negative Affect
      </label>
      <br>
      <div id="neg-legend" style="margin-top:10px; display:block;">
        <svg width="220" height="60"></svg>
      </div>
      <h3 style="margin-top:20px;">Correlation Heatmap</h3>
      <div id="heatmap-container">
        <svg id="heatmap" width="250" height="200"></svg>
      </div>
      <!-- Add more checkboxes/controls -->
    </div>
  </div>

  <div class="tooltip"></div>

  <script>
    // Use the map container, not the window, for sizing
    const mapContainer = document.getElementById("map-container");
    const width = mapContainer.clientWidth;
    const height = mapContainer.clientHeight;

    const svg = d3.select("#map-container svg");
    const tooltip = d3.select(".tooltip");

    const projection = d3.geoMercator()
      .scale(150)
      .translate([width / 2, height / 2]);

    const path = d3.geoPath().projection(projection);

    // Create a <g> for all map content so zoom works cleanly
    const g = svg.append("g");

    const zoom = d3.zoom()
      .scaleExtent([1, 8])
      .translateExtent([[0, 0], [width, height]])
      .on("zoom", (event) => {
        g.attr("transform", event.transform);
      });

    svg.call(zoom);

    // Helper: normalize country names for more reliable matching
    function normalize(name) {
      return name
        .toLowerCase()
        .replace(/,/g, "")
        .replace(/\./g, "")
        .replace(/the\s+/g, "")
        .replace(/\s+/g, " ")
        .trim();
    }

    // For convenience, keep data & color scale in outer scope so controls can use them
    let valueMap = new Map();
    let color = null;

    let currentYear = 2024;
    let playing = false;
    let playInterval = null;

    const slider = document.getElementById("year-slider");
    const yearLabel = document.getElementById("year-label");
    const playBtn = document.getElementById("play-btn");
    const pauseBtn = document.getElementById("pause-btn");

    // --- Toggle between map and heatmap ---
    const toggleBtn = document.getElementById("toggle-view-btn");
    const heatmapMainContainer = document.getElementById("heatmap-main-container");
    let showingMap = true;

    toggleBtn.addEventListener("click", () => {
      showingMap = !showingMap;
      
      if (showingMap) {
        mapContainer.style.display = "block";
        heatmapMainContainer.style.display = "none";
        toggleBtn.textContent = "Show Heatmap";
      } else {
        mapContainer.style.display = "none";
        heatmapMainContainer.style.display = "block";
        toggleBtn.textContent = "Show Map";
      }
    });

    // --- Slider drag behavior ---
    slider.addEventListener("input", function () {
      currentYear = +this.value;
      yearLabel.textContent = currentYear;

      // Call your eventual map update function here:
      // updateMap(currentYear);
    });

    // --- Play animation ---
    playBtn.addEventListener("click", () => {
      if (playing) return;   // already playing
      playing = true;

      playInterval = setInterval(() => {
        currentYear++;

        if (currentYear > 2024) {
          currentYear = 2010; // loop back to start
        }

        slider.value = currentYear;
        yearLabel.textContent = currentYear;

        // updateMap(currentYear);
      }, 800);  // change speed here (ms per step)
    });

    // --- Pause animation ---
    pauseBtn.addEventListener("click", () => {
      playing = false;
      clearInterval(playInterval);
    });



    Promise.all([
      d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json"),
      d3.csv("OECD_clean_large.csv")
    ]).then(([worldData, oecd]) => {
      // Filter to Negative Affect (example)
      const negAffect = oecd.filter(d =>
        normalize(d.measure) === normalize("NEGATIVE AFFECT BALANCE") ||
        d.measure === "NEG_AFFECT" ||
        d.measure === "11_2"
      );

      valueMap = new Map();
      negAffect.forEach(d => {
        const norm = normalize(d.reference_area);
        valueMap.set(norm, +d.value);
      });

      const values = [...valueMap.values()];
      const min = d3.min(values);
      const max = d3.max(values);
      const mid = d3.mean(values); 

      const color = d3.scaleDiverging()
        .domain([min, mid, max])
        .interpolator(d3.interpolateRdBu);

      // ----------------------
      // DRAW NEGATIVE AFFECT LEGEND (right under checkbox)
      // ----------------------
      const legendSvg = d3.select("#neg-legend svg");
      legendSvg.selectAll("*").remove();

      const legendWidth = 180;
      const legendHeight = 12;

      // Gradient
      const defs = legendSvg.append("defs");
      const gradient = defs.append("linearGradient")
        .attr("id", "negGrad")
        .attr("x1", "0%")
        .attr("x2", "100%");

      gradient.append("stop")
        .attr("offset", "0%")
        .attr("stop-color", color(min));

      gradient.append("stop")
        .attr("offset", "50%")
        .attr("stop-color", color(mid));

      gradient.append("stop")
        .attr("offset", "100%")
        .attr("stop-color", color(max));

      // Gradient bar
      legendSvg.append("rect")
        .attr("x", 20)
        .attr("y", 20)
        .attr("width", legendWidth)
        .attr("height", legendHeight)
        .style("fill", "url(#negGrad)")
        .style("stroke", "#333");

      // Axis
      const scale = d3.scaleLinear()
        .domain([min, max])
        .range([20, 20 + legendWidth]);

      const axis = d3.axisBottom(scale)
        .ticks(5)
        .tickSize(4);

      legendSvg.append("g")
        .attr("transform", `translate(0, ${20 + legendHeight})`)
        .call(axis);

      const countries = topojson.feature(worldData, worldData.objects.countries);

      g.selectAll("path")
        .data(countries.features)
        .enter()
        .append("path")
        .attr("d", path)
        .attr("stroke", "#333")
        .attr("fill", d => {
          const cname = normalize(d.properties.name);
          const val = valueMap.get(cname);
          return val != null ? color(val) : "#b0b0b0";
        })
        .on("mouseover", function(event, d) {
          const cname = normalize(d.properties.name);
          const val = valueMap.get(cname);

          d3.select(this).attr("opacity", 0.8);

          tooltip
            .style("opacity", 1)
            .html(
              `<strong>${d.properties.name}</strong><br>` +
              (val != null ? `Negative Affect: ${val}` : "No data")
            );
        })
        .on("mousemove", event => {
          tooltip
            .style("left", event.pageX + 10 + "px")
            .style("top", event.pageY + 10 + "px");
        })
        .on("mouseout", function() {
          d3.select(this).attr("opacity", 1);
          tooltip.style("opacity", 0);
        });

      // Example: hook up the checkbox to hide/show the values
      d3.select("#show-negative").on("change", function() {
        const checked = this.checked;

        // Show/hide the legend
        d3.select("#neg-legend")
          .style("display", checked ? "block" : "none");

        // Update map colors
        g.selectAll("path")
          .transition().duration(300)
          .attr("fill", d => {
            if (!checked) return "#f0f0f0";   // gray when off
            const cname = normalize(d.properties.name);
            const val = valueMap.get(cname);
            return val != null ? color(val) : "#b0b0b0";
          });
        
      });
      // ================================
      // SIMPLE 4×6 HEATMAP TEMPLATE (in sidebar)
      // ================================
      const heatmapSvg = d3.select("#heatmap");

      const rows = 8;
      const cols = 4;

      // dummy placeholder data
      const heatmapData = d3.range(rows * cols).map(i => ({
        r: Math.floor(i / cols),
        c: i % cols,
        value: Math.random()  // placeholder 0–1 values
      }));

      const cellSize = 42;
      const cellPadding = 1;
      const heatmapColor = d3.scaleSequential(d3.interpolateBlues)
        .domain([0, 1]); // placeholder domain

      // draw cells
      heatmapSvg
        .attr("width", cols * (cellSize + cellPadding) + 40)
        .attr("height", rows * (cellSize + cellPadding) + 40);

      heatmapSvg.selectAll("rect")
        .data(heatmapData)
        .enter()
        .append("rect")
        .attr("x", d => d.c * (cellSize + cellPadding) + 30)
        .attr("y", d => d.r * (cellSize + cellPadding) + 20)
        .attr("width", cellSize)
        .attr("height", cellSize)
        .attr("fill", d => heatmapColor(d.value))
        .attr("stroke", "#333");

      // optional row labels A, B, C, D
      heatmapSvg.selectAll(".row-label")
        .data(d3.range(rows))
        .enter()
        .append("text")
        .attr("class", "row-label")
        .attr("x", 5)
        .attr("y", d => d * (cellSize + cellPadding) + 20 + cellSize / 1.6)
        .text(d => "Row " + (d + 1))
        .style("font-size", "11px");

      // optional column labels 1–6
      heatmapSvg.selectAll(".col-label")
        .data(d3.range(cols))
        .enter()
        .append("text")
        .attr("class", "col-label")
        .attr("x", d => d * (cellSize + cellPadding) + 30 + cellSize / 2)
        .attr("y", 12)
        .attr("text-anchor", "middle")
        .text(d => "Col " + (d + 1))
        .style("font-size", "11px");

      // ================================
      // MAIN HEATMAP (placeholder for now)
      // ================================
      const heatmapMainSvg = d3.select("#heatmap-main");
      
      // This will be populated with the actual 25x25 correlation matrix later
      heatmapMainSvg
        .attr("width", 600)
        .attr("height", 600);
      
      heatmapMainSvg.append("text")
        .attr("x", 300)
        .attr("y", 300)
        .attr("text-anchor", "middle")
        .text("25×25 Correlation Heatmap will go here")
        .style("font-size", "16px")
        .style("fill", "#666");

    });
  </script>
</body>
</html>